<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>DUAL // MONOLITH · Navigator · Infodose</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#020202">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker Registered'));
    }
  </script>
  <meta name="description" content="Ambiente de navegação imersivo DUAL System">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            ui: ['Inter', 'sans-serif'],
            code: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            dual: {
              bg: '#020202',
              glass: 'rgba(10, 10, 12, 0.75)',
              border: 'rgba(255, 255, 255, 0.08)',
              cyan: '#00f2ff',
              purple: '#bd00ff',
              alert: '#ff4d4d',
            }
          },
          animation: {
            'scan': 'scan 3s linear infinite',
            'spin-slow': 'spin 8s linear infinite',
            'pulse-glow': 'pulseGlow 3s ease-in-out infinite',
            'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
            'fade-out': 'fadeOut 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards',
          },
          keyframes: {
            scan: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(200%)' }
            },
            pulseGlow: {
              '0%, 100%': { opacity: '0.4' },
              '50%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            fadeOut: {
              '0%': { opacity: '1', visibility: 'visible' },
              '99%': { opacity: '0', visibility: 'visible' },
              '100%': { opacity: '0', visibility: 'hidden' }
            }
          }
        }
      }
    }
  </script>

  <style>
    /* =========================
       CUSTOM STYLES & EFFECTS
       ========================= */
    :root {
      --glass-surface: rgba(15, 15, 20, 0.65);
      --glass-border: rgba(255, 255, 255, 0.08);
      --neon-cyan: #00f2ff;
    }

    body {
      background-color: #020202;
      overflow: hidden;
    }

    /* Ambient Background */
    .void-ambient {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background:
        radial-gradient(circle at 20% 120%, rgba(189,0,255,0.08), transparent 50%),
        radial-gradient(circle at 80% -20%, rgba(0,242,255,0.05), transparent 50%);
      transition: opacity 1s ease;
    }

    /* Scrollbar Customization */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* Monolith 3D Effect */
    .monolith-wrapper {
      perspective: 1200px;
      transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .monolith {
      background: var(--glass-surface);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border: 1px solid var(--glass-border);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      transform-style: preserve-3d;
      opacity: 0;
      transform: translateY(60px) rotateX(10deg) scale(0.95);
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
    }

    body.system-active .monolith {
      opacity: 1;
      transform: translateY(0) rotateX(0) scale(1);
      pointer-events: auto;
    }

    /* Runtime Layer Transition */
    .runtime-layer {
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.76, 0, 0.24, 1);
    }
    .runtime-layer.visible { transform: translateY(0); }

    /* Orb Styles */
    .orb-container {
      transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), bottom 0.5s ease;
    }
    body.system-active .orb-container {
      transform: translateX(-50%) scale(0.8);
      bottom: 2rem;
    }

    .orb {
      background: rgba(5, 5, 10, 0.6);
      backdrop-filter: blur(12px);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 0 20px rgba(0, 242, 255, 0.1);
      transition: all 0.3s ease;
    }
    .orb:hover {
      box-shadow: 0 0 0 1px rgba(0, 242, 255, 0.5), 0 0 40px rgba(0, 242, 255, 0.3);
      transform: scale(1.1);
    }

    /* Themes */
    body.theme-light { background: #e0e0e0; color: #111; }
    body.theme-light .monolith { background: rgba(255,255,255,0.85); border-color: rgba(0,0,0,0.1); }
    body.theme-light .orb { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.2); }
    body.theme-vibe { background: radial-gradient(circle at center, #2b1055, #000); }

    /* Utility Classes for JS toggles */
    .hidden-force { display: none !important; }
    .scanline {
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
      background-size: 100% 4px;
      pointer-events: none;
    }
  </style>
</head>
<body class="antialiased text-white selection:bg-dual-cyan selection:text-black">

  <!-- Splash / Initial Page -->
  <div id="splashScreen" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-1000">
    <!-- Background grid effect for splash -->
    <div class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:40px_40px] opacity-30 pointer-events-none"></div>
    <div class="absolute inset-0 bg-radial-gradient from-transparent to-black pointer-events-none"></div>

    <div class="z-10 flex flex-col items-center gap-6 animate-slide-up">
      <div class="w-20 h-20 rounded-full border border-dual-cyan/30 flex items-center justify-center relative">
        <div class="absolute inset-0 rounded-full border border-t-dual-cyan border-r-transparent border-b-transparent border-l-transparent animate-spin-slow"></div>
        <div class="w-10 h-10 bg-dual-cyan/10 rounded-full flex items-center justify-center backdrop-blur-md shadow-[0_0_30px_rgba(0,242,255,0.2)]">
          <span class="font-code font-bold text-dual-cyan text-xl">D</span>
        </div>
      </div>
      
      <div class="text-center">
        <h1 class="text-3xl font-bold font-ui tracking-tight mb-2">DUAL // SYSTEM</h1>
        <p class="text-xs font-code text-gray-500 tracking-widest uppercase">Ambiente Imersivo v2.0</p>
      </div>

      <button id="bootBtn" class="mt-8 px-8 py-3 rounded-xl bg-white/5 border border-white/10 hover:bg-dual-cyan hover:text-black hover:border-dual-cyan hover:shadow-[0_0_30px_rgba(0,242,255,0.4)] transition-all duration-300 font-code text-sm font-bold tracking-wider group">
        INICIALIZAR <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
      </button>
    </div>
    
    <div class="absolute bottom-8 text-[10px] text-gray-700 font-code">
      SECURE CONNECTION ESTABLISHED
    </div>
  </div>

  <!-- Ambient Background -->
  <div class="void-ambient w-full h-full" aria-hidden="true"></div>

  <!-- Background Navigator Iframe -->
  <iframe id="navFrame" src="./index.html" title="Navigator Background" class="fixed inset-0 w-full h-full border-0 z-0 bg-black transition-opacity duration-300"></iframe>

  <!-- Top Controls -->
  <div class="fixed top-6 left-1/2 -translate-x-1/2 z-50 flex items-center gap-4">
    <button id="themeToggle" class="w-10 h-10 rounded-full bg-dual-glass border border-dual-border flex items-center justify-center hover:bg-white/10 transition-colors backdrop-blur-md text-dual-cyan shadow-lg" title="Mudar Tema">
      <i class="fa-solid fa-circle-half-stroke text-lg"></i>
    </button>
  </div>

  <!-- Right Sidebar (Symbol Bar) -->
  <div class="fixed right-4 top-1/2 -translate-x-1/2 flex flex-col gap-3 z-40">
    <button class="w-10 h-10 rounded-xl bg-black/40 border border-white/5 text-dual-cyan hover:bg-dual-cyan hover:text-black transition-all backdrop-blur-sm flex items-center justify-center font-code" data-url="about:blank" title="Blank">Φ</button>
    <button class="w-10 h-10 rounded-xl bg-black/40 border border-white/5 text-dual-cyan hover:bg-dual-cyan hover:text-black transition-all backdrop-blur-sm flex items-center justify-center font-code" data-url="https://kodux78k.github.io/oiDual-Vivivi-1/" title="Vivivi">꩜</button>
    <button class="w-10 h-10 rounded-xl bg-black/40 border border-white/5 text-dual-cyan hover:bg-dual-cyan hover:text-black transition-all backdrop-blur-sm flex items-center justify-center font-code" data-url="https://kodux78k.github.io/NosSolar-dualInfodose/" title="Nosolar">☼</button>
    <button class="w-10 h-10 rounded-xl bg-black/40 border border-white/5 text-dual-cyan hover:bg-dual-cyan hover:text-black transition-all backdrop-blur-sm flex items-center justify-center font-code" data-url="https://kodux78k.github.io/DualInfodose-VirgemHuB/index.html" title="Atelie">◧</button>
  </div>

  <!-- Left Sidebar (Tools) -->
  <div class="fixed left-4 top-1/3 flex flex-col gap-3 z-40">
    <button id="uploadBtn" class="tool-btn w-10 h-10 rounded-xl bg-black/40 border border-white/5 text-gray-400 hover:text-white hover:border-dual-cyan/50 transition-all backdrop-blur-sm flex items-center justify-center" title="Upload HTML">
      <i class="fa-solid fa-file-import"></i>
    </button>
    <input id="uploadHTML" type="file" accept=".html" class="hidden">

    <button id="remoteBtn" class="tool-btn w-10 h-10 rounded-xl bg-black/40 border border-white/5 text-gray-400 hover:text-white hover:border-dual-cyan/50 transition-all backdrop-blur-sm flex items-center justify-center" title="Abrir URL">
      <i class="fa-solid fa-globe"></i>
    </button>

    <button id="decoderToggle" class="tool-btn w-10 h-10 rounded-xl bg-black/40 border border-white/5 text-gray-400 hover:text-white hover:border-dual-cyan/50 transition-all backdrop-blur-sm flex items-center justify-center" title="Decoder">
      <i class="fa-solid fa-key"></i>
    </button>

    <button id="ritualBtn" class="tool-btn w-10 h-10 rounded-xl bg-black/40 border border-white/5 text-dual-purple hover:text-white hover:border-dual-purple transition-all backdrop-blur-sm flex items-center justify-center" title="Ritual">
      <i class="fa-solid fa-wand-magic-sparkles"></i>
    </button>
  </div>

  <!-- Footer Navigation Dots -->
  <div class="fixed bottom-6 left-1/2 -translate-x-1/2 flex gap-4 z-40">
    <button id="dot-index" class="w-3 h-3 rounded-full bg-white/10 hover:bg-dual-cyan border border-transparent hover:border-dual-cyan transition-all" title="Index"></button>
    <button id="dot-base" class="w-5 h-5 rounded-full bg-transparent border border-dual-cyan shadow-[0_0_15px_rgba(0,242,255,0.3)] hover:bg-dual-cyan hover:shadow-[0_0_25px_rgba(0,242,255,0.6)] transition-all" title="Reset Base"></button>
    <button id="dot-last" class="w-3 h-3 rounded-full bg-white/10 hover:bg-dual-cyan border border-transparent hover:border-dual-cyan transition-all" title="Última Página"></button>
  </div>

  <!-- Decoder Modal (Absolute) -->
  <div id="decoderBox" class="fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-black/90 border border-white/10 p-3 rounded-xl backdrop-blur-xl shadow-2xl hidden animate-slide-up">
    <div class="flex items-center gap-2">
      <span class="text-dual-cyan font-code text-xs mr-2">://DECODER</span>
      <input id="codeInput" type="text" placeholder="INSIRA O SELO" class="bg-white/5 border border-white/10 rounded px-3 py-1 text-sm font-code text-white focus:border-dual-cyan focus:outline-none uppercase w-32">
      <button id="decodeBtn" class="bg-white/10 hover:bg-dual-cyan hover:text-black px-3 py-1 rounded text-sm font-bold transition-colors">ABRIR</button>
      <button id="closeDecoder" class="text-gray-500 hover:text-white px-2"><i class="fa-solid fa-xmark"></i></button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg bg-black/80 border border-dual-cyan/30 text-dual-cyan font-code text-sm shadow-xl z-[100] transition-all duration-300 opacity-0 pointer-events-none -translate-y-2">
    <span id="toastMsg">System Ready</span>
  </div>

  <!-- Orb Trigger (Bottom) - REDUZIDO DE w-20 PARA w-14 -->
  <div class="orb-container fixed bottom-10 left-1/2 -translate-x-1/2 z-[60]">
    <button id="orbBtn" class="orb w-14 h-14 rounded-full flex items-center justify-center relative group" aria-label="Toggle Monolith">
      <div class="orb-core w-2 h-2 bg-white rounded-full shadow-[0_0_15px_white] transition-all group-hover:bg-dual-cyan group-hover:shadow-[0_0_25px_#00f2ff]"></div>
      <div class="absolute inset-1 rounded-full border border-t-dual-cyan/60 border-r-transparent border-b-transparent border-l-transparent animate-spin-slow opacity-60"></div>
      <div class="absolute inset-3 rounded-full border border-b-dual-purple/60 border-l-transparent border-t-transparent border-r-transparent animate-spin-slow opacity-40" style="animation-direction: reverse;"></div>
    </button>
  </div>

  <!-- MONOLITH CARD (Main UI) -->
  <div class="monolith-wrapper fixed inset-0 z-[55] flex items-center justify-center pointer-events-none p-4">
    <div class="monolith w-full max-w-4xl h-[75vh] max-h-[800px] rounded-3xl flex flex-col overflow-hidden relative">

      <!-- Header -->
      <div class="flex justify-between items-center px-6 py-4 border-b border-white/5 bg-white/5">
        <div class="flex items-center gap-2 font-ui font-bold tracking-wider text-sm">
          <i data-lucide="layers" class="text-dual-cyan w-4 h-4"></i>
          DUAL <span class="text-white/40">//</span> MONO
        </div>
        <div id="sysStatus" class="font-code text-xs px-3 py-1 rounded bg-white/5 border border-white/5 text-gray-400">
          STANDBY
        </div>
      </div>

      <!-- Main Stage -->
      <div class="flex-1 p-6 overflow-y-auto flex flex-col gap-4 relative">
        <p class="text-xs text-gray-500 font-code mb-2">:: SISTEMA NOMINAL // SELECIONE O VETOR ::</p>

        <!-- Drop Zone -->
        <div id="dropZone" class="h-32 rounded-2xl border border-dashed border-white/10 bg-black/20 hover:bg-dual-cyan/5 hover:border-dual-cyan/40 transition-all cursor-pointer flex flex-col items-center justify-center gap-2 group">
          <i data-lucide="upload-cloud" class="text-gray-500 group-hover:text-dual-cyan transition-colors"></i>
          <span class="font-bold text-gray-400 group-hover:text-white text-sm">Carregar Stack / Módulo</span>
          <span id="fileName" class="text-[10px] text-gray-600 font-code uppercase">.HTML, .JSON, .JS</span>
          <input type="file" id="fileInput" hidden accept=".html,.json,.js" />
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-2 gap-3 mt-2">
          <button id="infodoseBtn" class="flex items-center justify-center gap-2 p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-dual-cyan/30 transition-all text-sm font-semibold">
            <i data-lucide="zap" class="w-4 h-4 text-dual-cyan"></i> Infodose
          </button>
          <button id="artRaskBtn" class="flex items-center justify-center gap-2 p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-dual-purple/30 transition-all text-sm font-semibold">
            <i data-lucide="cpu" class="w-4 h-4 text-dual-purple"></i> ArtRask
          </button>
        </div>

        <!-- Stack List -->
        <div id="stackList" class="flex flex-col gap-2 mt-4 pb-10">
          <!-- Items injected via JS -->
        </div>
      </div>

      <!-- Pulse Bar -->
      <div class="h-1 w-full bg-black/50 mt-auto relative overflow-hidden opacity-50">
        <div id="pulseBar" class="absolute inset-y-0 left-0 w-1/2 bg-gradient-to-r from-transparent via-dual-cyan to-transparent animate-scan opacity-0 transition-opacity duration-500"></div>
      </div>

      <!-- Runtime Layer (Overlay inside Monolith) -->
      <div id="runtimeLayer" class="runtime-layer absolute inset-0 bg-black z-20 flex flex-col">
        <div class="h-10 bg-[#0a0a0c] border-b border-white/10 flex items-center justify-between px-4">
          <span class="font-code text-xs text-dual-cyan">RUNTIME // SANDBOX</span>
          <div class="flex items-center gap-2">
            <button id="openInFrameBtn" class="text-[10px] bg-white/10 hover:bg-white/20 px-2 py-1 rounded transition-colors">EXPANDIR</button>
            <button id="closeRuntimeBtn" class="text-gray-400 hover:text-white transition-colors">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
        <div class="flex-1 relative bg-white">
          <iframe id="appFrame" class="w-full h-full border-0" sandbox="allow-scripts allow-forms allow-modals allow-same-origin"></iframe>
          <div class="scanline absolute inset-0 pointer-events-none opacity-20 mix-blend-overlay"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Web Component for Modals (fixed: fadeIn animation name) -->
  <script>
    class MyFrameLoader extends HTMLElement {
      constructor(){
        super();
        this.attachShadow({mode:'open'});
        this.shadowRoot.innerHTML = `
          <style>
            :host { all: initial; font-family: sans-serif; }
            .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 99999; animation: fadeIn 0.28s; }
            .box { width: 90%; height: 85%; background: #071017; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); transform: scale(0.95); animation: zoomIn 0.28s forwards; }
            .top { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #000; border-bottom: 1px solid #222; }
            .title { color: #888; font-size: 12px; font-family: monospace; }
            button { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; opacity: 0.7; transition: 0.2s; }
            button:hover { opacity: 1; color: #ff4d4d; }
            iframe { flex: 1; border: 0; width: 100%; height: 100%; background: #fff; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes zoomIn { to { transform: scale(1); } }
          </style>
          <div class="overlay" role="dialog" aria-modal="true">
            <div class="box">
              <div class="top">
                <span class="title">EXTERNAL // LOADER</span>
                <button class="close" title="Fechar" aria-label="Fechar">✖</button>
              </div>
              <iframe sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
            </div>
          </div>
        `;
        this.iframe = this.shadowRoot.querySelector('iframe');
        this.shadowRoot.querySelector('.close').onclick = () => this.remove();
        this.shadowRoot.querySelector('.overlay').onclick = (e) => { if(e.target === e.currentTarget) this.remove(); };
      }
      set src(v){ try { this.iframe.src = v; } catch(e){ console.error('Failed to set iframe src', e); } }
    }
    customElements.define('my-frame-loader', MyFrameLoader);
  </script>

  <!-- Application Logic -->
  <script>
    const App = {
      config: {
        storageKey: 'dual_last_page',
        stacksKey: 'dual_stacks_v2',
        themeKey: 'dual_theme',
        codeMap: {
          "DUAL": "menu.html",
          "KBX": "menu-x-1.html",
          "ATVR": "render-response.html",
          "337": "KOBLLUX_MetaLux_CLEANED.html"
        }
      },

      state: {
        active: false,
        stacks: [],
        infodose: false
      },

      refs: {
        body: document.body,
        navFrame: document.getElementById('navFrame'),
        sysStatus: document.getElementById('sysStatus'),
        stackList: document.getElementById('stackList'),
        pulseBar: document.getElementById('pulseBar'),
        orbBtn: document.getElementById('orbBtn'),
        toast: document.getElementById('toast'),
        toastMsg: document.getElementById('toastMsg'),
        runtimeLayer: document.getElementById('runtimeLayer'),
        appFrame: document.getElementById('appFrame'),
        splashScreen: document.getElementById('splashScreen'),
        bootBtn: document.getElementById('bootBtn')
      },

      init() {
        this.loadSettings();
        this.loadStacks();
        this.bindEvents();
        this.createIcons();

        // Boot Button Action
        this.refs.bootBtn.addEventListener('click', () => {
          this.refs.splashScreen.classList.add('animate-fade-out');
          setTimeout(() => {
            this.refs.splashScreen.style.display = 'none';
            this.toggleSystem(true); // Auto-open Monolith on boot
            this.showToast("SYSTEM INITIALIZED");
          }, 800);
        });

        console.log("%c DUAL // SYSTEM READY ", "background: #000; color: #00f2ff; font-weight: bold; padding: 4px; border: 1px solid #00f2ff;");
      },

      createIcons() {
        if(window.lucide) lucide.createIcons();
      },

      loadSettings() {
        // Theme
        const theme = localStorage.getItem(this.config.themeKey) || 'dark';
        this.setTheme(theme);

        // Last Page
        const lastPage = localStorage.getItem(this.config.storageKey);
        if(lastPage) this.refs.navFrame.src = lastPage;

        // Frame persistence
        this.refs.navFrame.onload = () => {
          try {
             // Try to save href if same origin, else save src
             const href = this.refs.navFrame.contentWindow.location.href;
             if(href !== 'about:blank') localStorage.setItem(this.config.storageKey, href);
          } catch(e) {
             localStorage.setItem(this.config.storageKey, this.refs.navFrame.src);
          }
        };
      },

      setTheme(themeName) {
        this.refs.body.className = this.refs.body.className.replace(/theme-\w+/g, '');
        if(themeName !== 'dark') this.refs.body.classList.add(`theme-${themeName}`);
        localStorage.setItem(this.config.themeKey, themeName);
      },

      toggleTheme() {
        const current = localStorage.getItem(this.config.themeKey) || 'dark';
        const themes = ['dark', 'light', 'vibe'];
        const next = themes[(themes.indexOf(current) + 1) % themes.length];
        this.setTheme(next);
        this.showToast(`TEMA: ${next.toUpperCase()}`);
      },

      toggleSystem(forceState) {
        this.state.active = forceState !== undefined ? forceState : !this.state.active;
        if(this.state.active) {
          this.refs.body.classList.add('system-active');
          this.refs.sysStatus.innerText = "READY";
          this.refs.sysStatus.className = "font-code text-xs px-3 py-1 rounded bg-dual-cyan/10 border border-dual-cyan/30 text-dual-cyan";
        } else {
          this.refs.body.classList.remove('system-active');
          this.refs.sysStatus.innerText = "STANDBY";
          this.refs.sysStatus.className = "font-code text-xs px-3 py-1 rounded bg-white/5 border border-white/5 text-gray-400";
        }
      },

      showToast(msg, duration = 2000) {
        this.refs.toastMsg.innerText = msg;
        this.refs.toast.classList.remove('opacity-0');
        this.refs.toast.style.pointerEvents = 'auto';
        clearTimeout(this.toastTimer);
        this.refs.toast.style.opacity = '1';
        this.toastTimer = setTimeout(() => {
          this.refs.toast.style.opacity = '0';
          this.refs.toast.style.pointerEvents = 'none';
        }, duration);
      },

      // --- STACK MANAGEMENT ---

      loadStacks() {
        try {
          const raw = localStorage.getItem(this.config.stacksKey);
          if(raw) this.state.stacks = JSON.parse(raw);
          this.renderStacks();
        } catch(e) { console.error("Stack load error", e); }
      },

      saveStacks() {
        localStorage.setItem(this.config.stacksKey, JSON.stringify(this.state.stacks));
      },

      addStack(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const newStack = {
            id: Date.now(),
            title: file.name,
            content: e.target.result,
            date: new Date().toLocaleDateString()
          };
          this.state.stacks.unshift(newStack);
          this.saveStacks();
          this.renderStacks();
          this.showToast("MÓDULO INTEGRADO");
          document.getElementById('fileName').innerText = file.name;
        };
        reader.readAsText(file);
      },

      removeStack(id) {
        if(confirm("Desintegrar este módulo?")) {
          this.state.stacks = this.state.stacks.filter(s => s.id !== id);
          this.saveStacks();
          this.renderStacks();
        }
      },

      runStack(id) {
        const stack = this.state.stacks.find(s => s.id === id);
        if(!stack) return;

        this.refs.appFrame.srcdoc = stack.content;
        this.refs.runtimeLayer.classList.add('visible');
        this.refs.sysStatus.innerText = "RUNNING";
        this.refs.sysStatus.classList.add('animate-pulse');
      },

      closeRuntime() {
        this.refs.runtimeLayer.classList.remove('visible');
        this.refs.sysStatus.classList.remove('animate-pulse');
        this.refs.sysStatus.innerText = "READY";
        setTimeout(() => { this.refs.appFrame.srcdoc = ''; }, 500);
      },

      renderStacks() {
        const list = this.refs.stackList;
        list.innerHTML = '';

        if(this.state.stacks.length === 0) {
          list.innerHTML = `<div class="text-center py-6 text-gray-600 font-code text-xs">NENHUM DADO ENCONTRADO</div>`;
          return;
        }

        this.state.stacks.forEach(stack => {
          const el = document.createElement('div');
          el.className = "flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 hover:border-dual-cyan/30 transition-all group cursor-pointer";
          el.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-lg bg-black/40 flex items-center justify-center text-dual-cyan/70 group-hover:text-dual-cyan">
                <i data-lucide="package" class="w-4 h-4"></i>
              </div>
              <div>
                <div class="font-bold text-sm text-gray-200 group-hover:text-white">${stack.title}</div>
                <div class="text-[10px] text-gray-500 font-code">${stack.date}</div>
              </div>
            </div>
            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="run-btn w-8 h-8 rounded-lg bg-dual-cyan text-black flex items-center justify-center hover:bg-white transition-colors" title="Executar">
                <i data-lucide="play" class="w-3 h-3 fill-current"></i>
              </button>
              <button class="del-btn w-8 h-8 rounded-lg border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition-colors" title="Apagar">
                <i data-lucide="trash-2" class="w-3 h-3"></i>
              </button>
            </div>
          `;

          el.querySelector('.run-btn').onclick = (e) => { e.stopPropagation(); this.runStack(stack.id); };
          el.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); this.removeStack(stack.id); };
          el.onclick = () => this.runStack(stack.id);

          list.appendChild(el);
        });

        this.createIcons();
      },

      // --- EVENT BINDING ---

      bindEvents() {
        // Orb Toggle
        this.refs.orbBtn.addEventListener('click', () => this.toggleSystem());

        // Theme
        document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());

        // Upload
        const upBtn = document.getElementById('uploadBtn');
        const upInput = document.getElementById('uploadHTML');
        upBtn.addEventListener('click', () => upInput.click());
        upInput.addEventListener('change', (e) => {
           if(e.target.files[0]) {
             // Local preview
             const url = URL.createObjectURL(e.target.files[0]);
             const modal = document.createElement('my-frame-loader');
             modal.src = url;
             document.body.appendChild(modal);
           }
        });

        // DropZone (Stack Add)
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
           if(e.target.files[0]) this.addStack(e.target.files[0]);
        });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-dual-cyan'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-dual-cyan'));
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('border-dual-cyan');
          if(e.dataTransfer.files[0]) this.addStack(e.dataTransfer.files[0]);
        });

        // Remote URL
        document.getElementById('remoteBtn').addEventListener('click', () => {
          const url = prompt("URL Remota:");
          if(url) {
             const modal = document.createElement('my-frame-loader');
             modal.src = url;
             document.body.appendChild(modal);
          }
        });

        // Decoder
        const decBox = document.getElementById('decoderBox');
        document.getElementById('decoderToggle').addEventListener('click', () => decBox.classList.toggle('hidden'));
        document.getElementById('closeDecoder').addEventListener('click', () => decBox.classList.add('hidden'));
        document.getElementById('decodeBtn').addEventListener('click', () => {
           const val = document.getElementById('codeInput').value.trim().toUpperCase();
           if(this.config.codeMap[val]) {
             const modal = document.createElement('my-frame-loader');
             modal.src = this.config.codeMap[val];
             document.body.appendChild(modal);
             decBox.classList.add('hidden');
             this.showToast(`SELO ABERTO: ${val}`);
           } else {
             this.showToast("SELO INVÁLIDO");
           }
        });

        // Navigation Dots
        document.getElementById('dot-index').onclick = () => {
           this.refs.navFrame.src = "index.html";
           this.showToast("INDEX CARREGADO");
        };
        document.getElementById('dot-base').onclick = () => {
           try { this.refs.navFrame.contentWindow.location.reload(); } catch(e) { this.refs.navFrame.src = this.refs.navFrame.src; }
           this.showToast("RESET RITUAL");
        };
        document.getElementById('dot-last').onclick = () => {
           const last = localStorage.getItem(this.config.storageKey);
           if(last) { this.refs.navFrame.src = last; this.showToast("RETOMANDO..."); }
        };

        // Symbol Bar (Right Sidebar) — only attach to elements that actually provide data-url
        document.querySelectorAll('[data-url]').forEach(btn => {
           if (!btn.dataset || !btn.dataset.url) return;
           btn.addEventListener('click', () => {
             this.refs.navFrame.src = btn.dataset.url;
             this.showToast(`NAV: ${btn.title || btn.dataset.url}`);
           });
           btn.addEventListener('contextmenu', (e) => {
             e.preventDefault();
             try { window.open(btn.dataset.url, '_blank'); }
             catch(err){ console.warn('Unable to open url in new tab', err); }
           });
        });

        // Feature Buttons
        document.getElementById('infodoseBtn').addEventListener('click', () => {
           this.state.infodose = !this.state.infodose;
           if(this.state.infodose) {
             this.refs.pulseBar.style.opacity = '1';
             this.showToast("INFODOSE: LINKED");
           } else {
             this.refs.pulseBar.style.opacity = '0';
             this.showToast("INFODOSE: UNLINKED");
           }
        });

        document.getElementById('ritualBtn').addEventListener('click', () => {
           this.refs.body.classList.add('animate-pulse');
           setTimeout(() => this.refs.body.classList.remove('animate-pulse'), 1000);
           this.showToast("VISUAL RITUAL");
        });

        // Runtime Controls
        document.getElementById('closeRuntimeBtn').onclick = () => this.closeRuntime();
        document.getElementById('openInFrameBtn').onclick = () => {
          if(this.refs.appFrame.srcdoc) {
             const blob = new Blob([this.refs.appFrame.srcdoc], {type: 'text/html'});
             const url = URL.createObjectURL(blob);
             this.refs.navFrame.src = url;
             this.showToast("EXPORTADO PARA FRAME");
             this.closeRuntime();
          }
        };
      }
    };

    // Bootstrap
    window.onload = () => App.init();
  </script>

  <!-- fusion-card web component (inlined, cleaned - no overwritten placeholder) -->
  <script>
    /* fusion-card-element.js (inlined, cleaned) */
    const template = document.createElement('template');
    template.innerHTML = `
      <style>
        :host{all:initial;display:block;font-family:Montserrat,system-ui,Arial,sans-serif;color:#fff}
        :host *{box-sizing:border-box}
        :root{--bg-deep:#030406;--glass-surface:rgba(18,18,22,0.65);--glass-border:rgba(255,255,255,0.06);--neon-cyan:#00f2ff;--neon-purple:#bd00ff;--neon-orange:#ff9a3c;--font-ui:'Montserrat',sans-serif;--font-code:monospace;--ease-overshoot:cubic-bezier(0.34,1.3,0.64,1);--ease-smooth:cubic-bezier(0.23,1,0.32,1)}
        .host-wrap{min-height:100vh;padding:12px;background:var(--bg-deep);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
        .ambient-light{position:absolute;inset:0;z-index:0;pointer-events:none}
        .blob{position:absolute;border-radius:50%;filter:blur(100px);opacity:0.12;animation:float 25s infinite alternate ease-in-out}
        .blob-1{width:50vw;height:50vw;background:var(--neon-cyan);top:-20%;left:-20%}
        .blob-2{width:40vw;height:40vw;background:var(--neon-purple);bottom:-20%;right:-20%;animation-delay:-5s}
        @keyframes float{0%{transform:translate(0,0)}100%{transform:translate(40px,60px)}}
        .container{width:100%;max-width:640px;padding:20px;z-index:10;display:flex;align-items:center;justify-content:center;perspective:1200px}
        .fusion-card{width:100%;max-width:440px;background:var(--glass-surface);backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);border:1px solid var(--glass-border);border-radius:36px;padding:30px 25px;box-shadow:0 40px 100px rgba(0,0,0,0.8);position:relative;overflow:hidden;opacity:0;transform:translateY(50px) scale(0.96);display:flex;flex-direction:column;gap:8px;will-change:width,padding,border-radius,box-shadow,transform}
        .fusion-card.active{opacity:1;transform:translateY(0) scale(1);transition:opacity .6s,transform .6s var(--ease-smooth)}
        .fusion-card.closed{width:260px;padding:14px 16px;border-radius:22px;box-shadow:0 22px 70px rgba(0,0,0,0.75);cursor:pointer}
        .fusion-card.closed .card-header{gap:10px;margin-bottom:0}
        .fusion-card.closed .brand-dual{font-size:1.3rem;margin-top:0;letter-spacing:-1px}
        .fusion-card.closed .greeting-row{font-size:1rem}
        .fusion-card.closed .txt-thin{display:none}
        .fusion-card.closed .card-body{display:none}
        .fusion-card.closed .avatar-slot{width:52px;height:52px}
        .fusion-card.animating{transition:none!important}
        .card-header{display:flex;align-items:center;gap:15px;margin-bottom:18px;transition:margin .3s}
        .avatar-slot{width:64px;height:64px;flex-shrink:0;border-radius:12px;overflow:hidden;opacity:0;transition:opacity .35s}
        .avatar-slot.shown{opacity:1}
        .text-block{flex:1;display:flex;flex-direction:column;justify-content:center}
        .greeting-row{font-size:1.5rem;line-height:1;display:flex;align-items:baseline;gap:6px;flex-wrap:wrap}
        .txt-thin{font-weight:200;color:rgba(255,255,255,0.7)}
        .txt-heavy{font-weight:600;color:#fff}
        .brand-dual{font-size:2.2rem;font-weight:900;line-height:0.95;text-transform:uppercase;letter-spacing:-2px;margin-top:4px;background:linear-gradient(-45deg,#fff,var(--neon-cyan),var(--neon-purple),#fff);background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradientFlow 4s ease infinite}
        @keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        .clock-widget{text-align:right}
        .time-display{font-family:var(--font-code);font-size:1rem;color:rgba(255,255,255,0.5);font-weight:700}
        .status-led{font-size:.6rem;color:var(--neon-cyan);text-transform:uppercase;letter-spacing:1px;margin-top:4px;display:block}
        .card-body{display:flex;flex-direction:column;gap:12px}
        .stagger-item{opacity:0;transform:translateY(15px);transition:opacity .4s ease, transform .4s var(--ease-overshoot)}
        .content-visible .stagger-item{opacity:1;transform:translateY(0)}
        .content-visible .stagger-item:nth-child(1){transition-delay:.1s}
        .content-visible .stagger-item:nth-child(2){transition-delay:.18s}
        .content-visible .stagger-item:nth-child(3){transition-delay:.25s}
        .input-wrapper{position:relative}
        .cyber-input{width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px 50px 16px 18px;color:#fff;font-family:var(--font-code);font-size:.9rem;transition:.2s}
        .cyber-input:focus{border-color:var(--neon-cyan);box-shadow:0 0 15px rgba(0,242,255,.08);background:rgba(0,0,0,.5)}
        .input-icon{position:absolute;right:18px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.3)}
        .trigger-btn{width:100%;padding:12px;border:1px dashed rgba(255,255,255,.1);border-radius:12px;background:rgba(255,255,255,.02);color:rgba(255,255,255,.5);font-size:.75rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px}
        .trigger-btn:hover{background:rgba(255,255,255,.04);color:#fff;border-color:rgba(255,255,255,.3)}
        .hidden-modules{display:grid;grid-template-rows:0fr;opacity:.6;transition:all 420ms var(--ease-smooth)}
        .fusion-card.open .hidden-modules{grid-template-rows:1fr;opacity:1;margin-top:10px}
        .modules-inner{overflow:hidden;display:flex;flex-direction:column;gap:12px;padding-top:2px}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
        .stat-box{background:rgba(255,255,255,.03);border-radius:12px;padding:10px;text-align:center;border:1px solid transparent;transition:.2s}
        .stat-box:hover{border-color:rgba(255,255,255,.1);background:rgba(255,255,255,.06)}
        .stat-lbl{font-size:.55rem;text-transform:uppercase;color:rgba(255,255,255,.4);display:block;margin-bottom:4px}
        .stat-val{font-family:var(--font-code);font-size:.9rem;font-weight:700;color:var(--neon-cyan)}
        .progress-container{background:rgba(0,0,0,.2);padding:12px;border-radius:12px}
        .bar-track{height:4px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;margin:8px 0}
        .bar-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--neon-cyan),var(--neon-purple));box-shadow:0 0 10px var(--neon-cyan);transition:width 1.2s ease-out}
        .bar-meta{display:flex;justify-content:space-between;font-size:.6rem;color:rgba(255,255,255,.4);font-family:var(--font-code)}
        .html-module-slot{border:1px solid var(--neon-orange);background:rgba(255,154,60,.05);border-radius:12px;padding:12px;min-height:56px;display:flex;align-items:center;justify-content:center;color:var(--neon-orange);font-size:.7rem;font-family:var(--font-code);text-align:center}
        .small-preview{display:none;align-items:center;gap:10px;margin-top:8px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.03);font-family:var(--font-code);font-size:.86rem;color:rgba(255,255,255,.9);cursor:pointer;overflow:hidden}
        .small-preview .mini-avatar{width:30px;height:30px;border-radius:6px;flex-shrink:0;overflow:hidden;display:inline-flex;align-items:center;justify-content:center}
        .small-preview .small-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 110px)}
        .small-preview .ident-badge{margin-left:auto;font-weight:700;font-size:.78rem;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.03);color:rgba(255,255,255,.9);border:1px solid rgba(255,255,255,.02)}
        .fusion-card.closed .small-preview{display:flex}
        .vibe-gold{box-shadow:0 0 0px rgba(255,210,80,0);animation:vibePulse 1.6s infinite;border:1px solid rgba(255,210,80,.15)}
        @keyframes vibePulse{0%{box-shadow:0 0 0 0 rgba(255,210,80,0);transform:translateY(0)}40%{box-shadow:0 0 18px 6px rgba(255,210,80,.06);transform:translateY(-1px) scale(1.01)}100%{box-shadow:0 0 0 0 rgba(255,210,80,0);transform:translateY(0)}}
        .activation-wrap{display:flex;flex-direction:column;gap:8px;margin-top:6px}
        .activation-toggle{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.04);cursor:pointer;background:rgba(255,255,255,.02)}
        .activation-card{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.03);padding:12px;border-radius:12px;overflow:hidden;transition:all 280ms var(--ease-smooth)}
        .activation-pre{font-family:var(--font-code);white-space:pre-wrap;margin:0;padding:8px;background:rgba(0,0,0,.12);border-radius:8px;border:1px dashed rgba(255,255,255,.03);color:#fff}
        .activation-hidden{max-height:0;opacity:0;padding:0 12px;pointer-events:none}
        .activation-open{max-height:400px;opacity:1;padding:12px}
        .activation-controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
        .toaster{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,.8);padding:10px 14px;border-radius:8px;color:#fff;font-family:var(--font-code);font-size:.85rem;transform:translateY(8px);opacity:0;transition:all .26s}
        .toaster.show{opacity:1;transform:translateY(0)}
        @media (max-width:420px){ .fusion-card.closed{width:220px} .brand-dual{font-size:1rem} }
      </style>

      <div class="host-wrap" part="host">
        <div class="ambient-light" part="ambient">
          <div class="blob blob-1"></div>
          <div class="blob blob-2"></div>
        </div>

        <div class="container" part="container">
          <div class="fusion-card closed" part="card" aria-expanded="false">
            <div class="card-header" part="header" role="button" tabindex="0" aria-controls="cardBody" aria-expanded="false">
              <div class="avatar-slot" part="avatar"></div>

              <div class="text-block">
                <div class="greeting-row">
                  <span class="txt-thin" id="lblHello">Sistema</span>
                  <span class="txt-heavy" id="lblName">Convidado</span>
                </div>
                <div class="brand-dual">DUAL</div>
              </div>

              <div class="clock-widget" aria-hidden="true">
                <div class="time-display" id="clockTime">00:00</div>
                <span class="status-led">ONLINE</span>
              </div>
            </div>

            <div class="small-preview" id="smallPreview" title="Clique para abrir e editar a ativação">
              <div class="mini-avatar" id="smallMiniAvatar" aria-hidden="true"></div>
              <div class="small-text" id="smallText">Ativação aparecerá aqui</div>
              <div class="ident-badge" id="smallIdent">--</div>
            </div>

            <div class="card-body" id="cardBody">
              <div class="input-wrapper stagger-item">
                <input type="text" class="cyber-input" id="inputUser" placeholder="Identifique-se..." autocomplete="off" />
                <span class="input-icon" id="iconFingerprint" title="fingerprint" aria-hidden="true"></span>
              </div>

              <div class="trigger-btn stagger-item" id="modulesToggle">
                <span id="triggerText">ABRIR MÓDULOS</span>
                <svg id="iconChevron" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 10l5 5 5-5z"></path></svg>
              </div>

              <div class="activation-wrap stagger-item">
                <div class="activation-toggle" id="activationToggle" role="button" tabindex="0" aria-expanded="false">
                  <div style="display:flex;align-items:center;gap:8px">
                    <div style="width:10px;height:10px;border-radius:99px;background:var(--neon-cyan)"></div>
                    <strong style="letter-spacing:1px">Ativação ASCII</strong>
                  </div>
                  <div style="margin-left:auto;font-size:.82rem;color:rgba(255,255,255,.6)">BASE v1</div>
                </div>

                <div id="activationCard" class="activation-card activation-hidden" aria-live="polite">
                  <div style="display:flex;align-items:flex-start;gap:10px">
                    <div style="display:flex;align-items:center;gap:8px">
                      <div class="mini-avatar" id="actMiniAvatar" aria-hidden="true"></div>
                      <div style="display:flex;flex-direction:column;">
                        <div id="actTitle" style="font-weight:700">CÉREBRO-ORÁCULO — BASE v1</div>
                        <div style="font-size:.78rem;color:rgba(255,255,255,.55)">Ativar: <span id="actName">(Convidado).Dual Infodose</span></div>
                      </div>
                    </div>
                    <div style="margin-left:auto;display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                      <div class="activation-badge" id="actBadge">v:--</div>
                      <div style="font-size:.72rem;color:rgba(255,255,255,.45)">Rolling system</div>
                    </div>
                  </div>

                  <pre id="actPre" class="activation-pre" aria-hidden="false">
+------------------------------+
| CÉREBRO-ORÁCULO — BASE v1    |
+------------------------------+
Ativar: (Convidado).Dual Infodose
                  </pre>

                  <div class="activation-controls">
                    <button class="trigger-btn" id="copyActBtn" type="button">COPIAR</button>
                    <button class="trigger-btn" id="downloadActBtn" type="button">EXPORT PNG</button>
                  </div>
                </div>
              </div>

              <div class="hidden-modules stagger-item" id="modulesArea">
                <div class="modules-inner">
                  <div class="stats-grid">
                    <div class="stat-box"><span class="stat-lbl">LATÊNCIA</span><span class="stat-val">12ms</span></div>
                    <div class="stat-box"><span class="stat-lbl">CPU</span><span class="stat-val">FUSION</span></div>
                    <div class="stat-box"><span class="stat-lbl">RITMO</span><span class="stat-val">BETA</span></div>
                  </div>

                  <div class="progress-container">
                    <div class="bar-meta"><span>CICLO DIÁRIO</span><span id="cyclePercent">0%</span></div>
                    <div class="bar-track"><div class="bar-fill" id="cycleFill"></div></div>
                  </div>

                  <div class="html-module-slot" id="htmlSlot">// MÓDULO EXTERNO — PRONTO PARA INJEÇÃO HTML</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="toasterWrap"></div>
      </div>
    `;

    class FusionCard extends HTMLElement {
      constructor(){
        super();
        this._shadow = this.attachShadow({mode:'open'});
        this._shadow.appendChild(template.content.cloneNode(true));
        // element refs
        this.$ = sel => this._shadow.querySelector(sel);
        this.card = this.$('.fusion-card');
        this.header = this.$('.card-header');
        this.avatarSlot = this.$('.avatar-slot');
        this.input = this.$('#inputUser');
        this.lblHello = this.$('#lblHello');
        this.lblName = this.$('#lblName');
        this.clock = this.$('#clockTime');
        this.triggerText = this.$('#triggerText');
        this.modulesToggle = this.$('#modulesToggle');
        this.modulesArea = this.$('#modulesArea');
        this.smallPreview = this.$('#smallPreview');
        this.smallMiniAvatar = this.$('#smallMiniAvatar');
        this.smallText = this.$('#smallText');
        this.smallIdent = this.$('#smallIdent');
        this.activationToggle = this.$('#activationToggle');
        this.activationCard = this.$('#activationCard');
        this.actPre = this.$('#actPre');
        this.actName = this.$('#actName');
        this.actMiniAvatar = this.$('#actMiniAvatar');
        this.actBadge = this.$('#actBadge');
        this.copyActBtn = this.$('#copyActBtn');
        this.downloadActBtn = this.$('#downloadActBtn');
        this.cycleFill = this.$('#cycleFill');
        this.cyclePercent = this.$('#cyclePercent');
        this.htmlSlot = this.$('#htmlSlot');
        this.toasterWrap = this._shadow.getElementById('toasterWrap') || this._shadow.querySelector('#toasterWrap');
        // internal
        this._interval = null;
        this._mounted = false;
        this._animations = [];
      }

      connectedCallback(){
        if(this._mounted) return;
        this._mounted = true;
        // initialize avatar
        this.avatarSlot.innerHTML = this._createAvatarSVG('B',64);
        // events
        this._onHeaderClick = this._toggleCard.bind(this);
        this._onHeaderKey = e => { if(e.key==='Enter'||e.key===' ') { e.preventDefault(); this._toggleCard(); } };
        this.header.addEventListener('click', this._onHeaderClick);
        this.header.addEventListener('keydown', this._onHeaderKey);

        this._onSmallPreview = () => {
          if(this.card.classList.contains('closed')) { this._toggleCard(); setTimeout(()=> this.input && this.input.focus(), 500); }
          else this.input && this.input.focus();
        };
        this.smallPreview.addEventListener('click', this._onSmallPreview);

        this._onInput = (e) => {
          const v = e.target.value;
          if(v){ this.lblHello.textContent = 'Oi,'; this.lblName.textContent = v; }
          else { this.lblHello.textContent = 'Sistema'; this.lblName.textContent = 'Convidado'; }
          this._updateSmallPreviewFromName(v);
        };
        this.input.addEventListener('input', this._onInput);
        this._onBlur = (e) => {
          const v = e.target.value.trim();
          if(v){ localStorage.setItem('fusion_user', v); this.speak(`Usuário ${v} confirmado.`); this._updateSmallPreviewFromName(v); }
        };
        this.input.addEventListener('blur', this._onBlur);
        this.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') e.target.blur(); });

        this.modulesToggle.addEventListener('click', ()=> this.toggleDetails());
        this.activationToggle.addEventListener('click', ()=> this.toggleActivation());
        this.activationToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); this.toggleActivation(); }});
        this.copyActBtn.addEventListener('click', ()=> this.copyActivation());
        this.downloadActBtn.addEventListener('click', ()=> this.exportActivationPNG());

        // icons: fingerprint -> inline svg
        this.$('#iconFingerprint').innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C10 2 4 3 4 9v3c0 4 3 7 8 7s8-3 8-7V9c0-6-6-7-8-7z"></path></svg>`;

        // initial metrics update
        this._updateMetrics();
        this._interval = setInterval(()=> this._updateMetrics(),1000);

        // animate in
        setTimeout(()=> { this.card.classList.add('active'); this.avatarSlot.classList.add('shown'); },120);

        // bootstrap with saved user
        const saved = localStorage.getItem('fusion_user') || '';
        if(saved) { this.setUserName(saved); this.speak(`Bem-vindo de volta, ${saved}.`); }
        else { this.speak('Sistema Dual pronto.'); this._updateSmallPreviewFromName(''); }

        // populate activation block
        this._updateActivationBlock(saved || 'Convidado');
      }

      disconnectedCallback(){
        this.destroy();
      }

      // ========== public API ==========
      setUserName(name){
        if(!this.input) return;
        this.input.value = name;
        this.lblHello.textContent = 'Oi,';
        this.lblName.textContent = name;
        this._updateSmallPreviewFromName(name);
        localStorage.setItem('fusion_user', name);
      }

      open(){ if(this.card.classList.contains('closed')) this._toggleCard(); }
      close(){ if(!this.card.classList.contains('closed')) this._toggleCard(); }
      toggle(){ this._toggleCard(); }

      destroy(){
        if(!this._mounted) return;
        this._mounted = false;
        try {
          this.header.removeEventListener('click', this._onHeaderClick);
          this.header.removeEventListener('keydown', this._onHeaderKey);
          this.smallPreview.removeEventListener('click', this._onSmallPreview);
          this.input.removeEventListener('input', this._onInput);
          this.input.removeEventListener('blur', this._onBlur);
          clearInterval(this._interval);
          window.speechSynthesis && window.speechSynthesis.cancel();
        } catch(e){}
      }

      // ========== internal helpers ==========
      _createAvatarSVG(id,size=64){
        return `
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" aria-hidden="true">
            <defs>
              <linearGradient id="g${id}" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#00f2ff;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#bd00ff;stop-opacity:1" />
              </linearGradient>
              <filter id="f${id}"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            </defs>
            <circle cx="50" cy="50" r="48" fill="#080b12" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
            <path d="M50 15 A35 35 0 0 1 85 50" stroke="url(#g${id})" stroke-width="4" fill="none" stroke-linecap="round">
              <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="4s" repeatCount="indefinite"/>
            </path>
            <path d="M50 85 A35 35 0 0 1 15 50" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.5">
               <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="-360 50 50" dur="8s" repeatCount="indefinite"/>
            </path>
            <circle cx="50" cy="50" r="20" fill="url(#g${id})" filter="url(#f${id})" opacity="0.9"/>
          </svg>
        `;
      }

      _hashString(str){
        let h = 2166136261 >>> 0;
        for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619) >>> 0; }
        return h >>> 0;
      }
      _seedToGradient(seed, id='s'){
        const h1 = seed % 360;
        const h2 = (seed * 37) % 360;
        return {id:`gSmall${id}`, svg:`<linearGradient id="gSmall${id}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="hsl(${h1} 100% 55%)"/><stop offset="100%" stop-color="hsl(${h2} 90% 45%)"/></linearGradient>`};
      }
      _makeMiniAvatarHTML(name,size=30){
        const seed = this._hashString(name || 'DUAL');
        const grad = this._seedToGradient(seed, seed.toString(36));
        return `<svg width="${size}" height="${size}" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><defs>${grad.svg}</defs><rect x="0" y="0" width="32" height="32" rx="6" fill="#071018" /><circle cx="16" cy="12" r="6" fill="url(#${grad.id})"/><path d="M16 24 a8 4 0 0 1 8 -4" stroke="rgba(255,255,255,0.06)" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`;
      }

      _reduce369Short(name){
        if(!name || !name.trim()) return '--';
        const s = name.split('').reduce((acc,ch)=> acc + ch.charCodeAt(0), 0);
        let root = s;
        while(root > 9) root = String(root).split('').reduce((a,b)=>a+Number(b), 0);
        return root;
      }

      _createAsciiActivation(name){
        const displayName = name && name.trim() ? `${name.trim()}.Dual Infodose` : '(Convidado).Dual Infodose';
        const root = this._reduce369Short(name);
        const title = 'CÉREBRO-ORÁCULO — BASE v1';
        const content = `Ativar: ${displayName}`;
        const width = Math.max(title.length, content.length) + 4;
        const top = '+' + '-'.repeat(width) + '+';
        const midTitle = `| ${title.padEnd(width - 1)}|`;
        const top2 = '+' + '-'.repeat(width) + '+';
        const ascii = `${top}\n${midTitle}\n${top2}\n${content}\n`;
        return { ascii, displayName, root, title, content };
      }

      _updateActivationBlock(name){
        const r = this._createAsciiActivation(name);
        if(this.actPre) this.actPre.innerText = r.ascii;
        if(this.actName) this.actName.innerText = r.displayName;
        if(this.actMiniAvatar) this.actMiniAvatar.innerHTML = this._makeMiniAvatarHTML(name||'DUAL',36);
        if(this.actBadge){ this.actBadge.innerText = `v:${r.root}`; this.actBadge.classList.remove('vibe-gold'); if(r.root===3||r.root===6||r.root===9) this.actBadge.classList.add('vibe-gold'); }
      }

      _updateSmallPreviewFromName(name){
        const now = new Date();
        const PHRASES_24 = [
          "Ativar foco estável.","Sintonizar ritmo criativo.","Amplificar percepção sutil.","Conectar ao core de coesão.",
          "Iniciar limpeza cognitiva.","Engatar modo produtividade.","Equilibrar fluxo emocional.","Elevar nível de curiosidade.",
          "Refinar intenção principal.","Fortalecer memória ativa.","Sincronizar com ciclo terrestre.","Ativar shield de atenção.",
          "Optimizar caminhos de decisão.","Despertar intuição prática.","Atenuar ruídos internos.","Mapear prioridades do dia.",
          "Habilitar modo aprendizado.","Sintonizar voz interior clara.","Aumentar resiliência mental.","Abrir canal de insights.",
          "Energetizar campo criativo.","Ancorar objetivos curtos.","Preparar para execução suave.","Concluir com gratidão."
        ];
        const phrase = PHRASES_24[now.getHours()%24];
        const miniText = (name && name.trim()) ? `${name.trim()} · ${phrase}` : `Ativação aparecerá aqui`;
        if(this.smallText) this.smallText.innerText = miniText;
        const root = this._reduce369Short(name);
        if(this.smallIdent) this.smallIdent.innerText = (name && name.trim()) ? `v:${root}` : '--';
        if(this.smallPreview) this.smallPreview.classList.remove('vibe-gold');
        if(root===3||root===6||root===9) this.smallPreview && this.smallPreview.classList.add('vibe-gold');
        if(this.smallMiniAvatar) this.smallMiniAvatar.innerHTML = this._makeMiniAvatarHTML(name||'DUAL',30);
        this._updateActivationBlock(name||'Convidado');
      }

      _updateMetrics(){
        const now = new Date();
        if(this.clock) this.clock.innerText = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
        const pct = Math.min(100, Math.max(0, ((now.getHours()+now.getMinutes()/60)/24)*100));
        if(this.cycleFill) this.cycleFill.style.width = `${pct}%`;
        if(this.cyclePercent) this.cyclePercent.innerText = `${Math.floor(pct)}%`;
      }

      speak(text){
        if(!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        if(!text) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'pt-BR'; u.rate = 1.05;
        window.speechSynthesis.speak(u);
      }

      _toggleCard(){
        if(this.card.classList.contains('animating')) return;
        const isOpening = this.card.classList.contains('closed');
        this.card.classList.add('animating');
        const start = isOpening ? {width:'260px',padding:'14px 16px',borderRadius:'22px',boxShadow:'0 22px 70px rgba(0,0,0,0.75)',scale:.995} : {width:'440px',padding:'30px 25px',borderRadius:'36px',boxShadow:'0 40px 100px rgba(0,0,0,0.8)',scale:1};
        const end = isOpening ? {width:'440px',padding:'30px 25px',borderRadius:'36px',boxShadow:'0 40px 100px rgba(0,0,0,0.8)',scale:1} : {width:'260px',padding:'14px 16px',borderRadius:'22px',boxShadow:'0 22px 70px rgba(0,0,0,0.75)',scale:.995};
        if(isOpening){ this.card.classList.remove('closed'); this.card.setAttribute('aria-expanded','true'); } else { this.card.classList.remove('content-visible'); if(this.card.classList.contains('open')) this.toggleDetails(); }
        this.card.style.width = start.width; this.card.style.padding = start.padding; this.card.style.borderRadius = start.borderRadius; this.card.style.boxShadow = start.boxShadow; this.card.style.transform = `scale(${start.scale})`;
        const duration = isOpening ? 600 : 450;
        const easing = isOpening ? 'cubic-bezier(0.34,1.3,0.64,1)' : 'cubic-bezier(0.23,1,0.32,1)';
        const anim = this.card.animate([
          { width:start.width,padding:start.padding,borderRadius:start.borderRadius,boxShadow:start.boxShadow,transform:`scale(${start.scale})` },
          { width:end.width,padding:end.padding,borderRadius:end.borderRadius,boxShadow:end.boxShadow,transform:`scale(${end.scale})` }
        ], {duration, easing, fill:'forwards'});
        anim.onfinish = () => {
          this.card.classList.remove('animating');
          this.card.style.width=''; this.card.style.padding=''; this.card.style.borderRadius=''; this.card.style.boxShadow=''; this.card.style.transform='';
          if(isOpening){ this.card.classList.add('content-visible'); this.input && this.input.focus(); } else { this.card.classList.add('closed'); this.card.setAttribute('aria-expanded','false'); }
        };
      }

      toggleDetails(){
        this.card.classList.toggle('open');
        const isOpen = this.card.classList.contains('open');
        this.triggerText && (this.triggerText.innerText = isOpen ? 'FECHAR MÓDULOS' : 'ABRIR MÓDULOS');
        // chevron rotation by transform
        const icon = this.$('#iconChevron');
        if(icon) icon.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        if(isOpen) this.speak('Carregando módulos.');
      }

      toggleActivation(){
        if(!this.activationCard) return;
        const wasHidden = this.activationCard.classList.contains('activation-hidden');
        this.activationCard.classList.toggle('activation-hidden');
        this.activationCard.classList.toggle('activation-open');
        this.activationToggle.setAttribute('aria-expanded', String(wasHidden));
        if(wasHidden){
          const text = this.actPre ? this.actPre.innerText.replace(/\n/g,' ') : 'Ativação aberta';
          this.speak(text);
        }
      }

      async copyActivation(){
        if(!this.actPre) return;
        const text = this.actPre.innerText;
        try {
          if(navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(text);
          else { const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
          this._showToaster('Ativação copiada');
        } catch(e){ this._showToaster('Erro copiando'); }
      }

      // Export activation to PNG via Canvas (no html2canvas dependency)
      exportActivationPNG(){
        const ascii = this.actPre ? this.actPre.innerText : '';
        if(!ascii) { this._showToaster('Nada para exportar'); return; }
        const lines = ascii.split('\n');
        const padding = 18;
        const lineHeight = 18;
        const font = '16px monospace';
        // measure width using an offscreen canvas
        const measureCanvas = document.createElement('canvas');
        const mctx = measureCanvas.getContext('2d');
        mctx.font = font;
        let maxWidth = 0;
        for(const l of lines){ const w = mctx.measureText(l).width; if(w>maxWidth) maxWidth = w; }
        const width = Math.ceil(maxWidth + padding*2);
        const height = Math.ceil(lines.length*lineHeight + padding*2);
        const canvas = document.createElement('canvas');
        canvas.width = width * devicePixelRatio;
        canvas.height = height * devicePixelRatio;
        canvas.style.width = `${width}px`;
        canvas.style.height = `${height}px`;
        const ctx = canvas.getContext('2d');
        ctx.scale(devicePixelRatio, devicePixelRatio);
        // background
        ctx.fillStyle = '#0b0d10';
        ctx.fillRect(0,0,width,height);
        // border
        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 1;
        ctx.strokeRect(8,8,width-16,height-16);
        // dashed inner line
        ctx.setLineDash([6,6]);
        ctx.strokeStyle = 'rgba(255,255,255,0.03)';
        ctx.strokeRect(12,12,width-24,height-24);
        ctx.setLineDash([]);
        // draw text
        ctx.font = font;
        ctx.fillStyle = '#fff';
        ctx.textBaseline = 'top';
        let y = padding;
        for(const l of lines){
          ctx.fillText(l, padding, y);
          y += lineHeight;
        }
        // download
        const a = document.createElement('a');
        a.download = `activation-${(new Date()).toISOString().replace(/[:.]/g,'')}.png`;
        a.href = canvas.toDataURL('image/png');
        a.click();
        this._showToaster('Exportado PNG');
      }

      _showToaster(text, ms = 2400){
        // simple light DOM-free toaster inside shadow
        const t = document.createElement('div');
        t.className = 'toaster';
        t.textContent = text + ' — (toaster: implementação futura)';
        const wrap = this._shadow.getElementById('toasterWrap') || this.toasterWrap;
        (wrap || this._shadow.host).appendChild(t);
        requestAnimationFrame(()=> t.classList.add('show'));
        setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.remove(),300); }, ms);
      }
    }

    customElements.define('fusion-card', FusionCard);
    // note: not exporting here so this inlined file works in regular <script> contexts
  </script>

  <!-- Initialize lucide icons (if present) -->
  <script>
    // create icons for any lucide placeholders after elements have loaded
    window.addEventListener('load', () => {
      try { if(window.lucide) lucide.createIcons(); } catch(e){ console.warn('lucide createIcons failed', e); }
    });
  </script>
</body>
</html>


